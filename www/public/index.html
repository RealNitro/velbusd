<html>
 <head>
  <title>Domotica control</title>
  <script src="js/jquery.js"></script>
  <style>
	div.icon {
		position: absolute;
		width: 1.2em;
		height: 1.2em;
		cursor: pointer;
		background-image: url(images/unknown);
		background-size: contain;
	}
	div.icon div {
		cursor: auto;
	}

	div.popover {
		top: 1.3em; /* Place them below the icon */
		background-color: #000000;
		color: #dddddd;
		padding: 10px;
		z-index: 1000;
		position: absolute;
		min-width: 10em;
	}
	span.tech {
		font-size: 0.75em;
	}
	div.template {
		display: none;
	}
  </style>
  </head>
 <body>
  <h1>Domotica control</h1>
  <div style="position: relative" id="floormap">
   <div id="control" class="popover template">
    <!-- Header line, common for all -->
    <div style="white-space: nowrap; padding-bottom: .4em;">
     <span class="name">Name</span>
     <span class="tech">(<span class="type">type</span> @ <span class="id">FF</span>)</span>
    </div>
   </div>

   <img src="data/floorplan.svg" />

   <script type="text/javascript">
	var coords;
	$.ajax({ url: 'data/coords.json', dataType: 'json'})
	  .error(function(jqXHR, text, error) { alert('error:'+text); })
	  .success(function(data) {
		coords = data; // Store data for later
		$.each(data, function(id, el) {

			if( el.type == undefined ) {
				console.log('Elements must have at least `type` attributes, '+
					'ignoring this one');
				return true; // continue to next iteration
			}

			for( var i in el.coords ) {
				var icon = $('<div class="icon"/>').addClass( el.type );
				$("#floormap").append( icon );
				icon.css('left', el.coords[i].left - icon.width()/2 )
				    .css('top', el.coords[i].top - icon.height()/2);

				icon.click( (function (i) { return function() { // Create closure with `i` in it
					// Closure with all details
					var popover = $('.popover');
					popover.find('.control').addClass('template');
					popover.removeClass('template').appendTo(icon);

					popover.find('.name').text(el.name);
					popover.find('.id').text(id);
					popover.find('.type').text(el.type);
					$('.control.' + el.type).removeClass('template').trigger('update', [id, el, i]);

					// Undo selection which has happened while clicking and appending at the same time
					if (window.getSelection) {
						if (window.getSelection().empty) {  // Chrome
							window.getSelection().empty();
						} else if (window.getSelection().removeAllRanges) {  // Firefox
							window.getSelection().removeAllRanges();
						}
					} else if (document.selection) {  // IE?
						document.selection.empty();
					}

					return false;
				}})(i));
			}
		});
		$(document).click( function() { $('.popover').addClass('template'); } );
	});
   </script>
   <script src="js/controls.js"></script>
  </div>
  <div id="macros">
   <input type="button" id="macro-all-lights-off" value="All lights off" />
   <script type="text/javascript">
    $("#macro-all-lights-off").click(function() {
		for( var id in coords ) {
			if( coords[id].type == "light" ) {
				console.log(id);
				$.ajax({
					type: 'POST',
					url: 'control/relay/' + id + "/status",
					data: 'off',
				});
			}
		}
		return false;
	});
   </script><br/>
   <input type="button" id="macro-all-blinds-up" value="All blinds up" /><br/>
   <input type="button" id="macro-all-blinds-down" value="All blinds down" />
   <script language="javascript">
    function macro_all_blinds( status ) {
		for( var id in coords ) {
			if( coords[id].type == "blind" ) {
				console.log(id);
				$.ajax({
					type: 'POST',
					url: 'control/blind/' + id + "/status",
					data: status,
				});
			}
		}
		return false;
	}
    $("#macro-all-blinds-up").click(function() { macro_all_blinds('up'); });
    $("#macro-all-blinds-down").click(function() { macro_all_blinds('down'); });
   </script>
  </div>
  <script src="js/sockjs.js"></script>
  <script type="text/javascript">
	var sockjs = new SockJS('/events');
	velbus_state = {};
	sockjs.onopen = function() {
		console.log("SockJS open");
	};
	sockjs.onclose = function() {
		console.log("SockJS close");
	};
	sockjs.onmessage = function(e) {
		var d = JSON.parse(e.data);
		if( d.changetype == 'new' ) {
			velbus_state = d.value;
		} else if( d.changetype == 'update' ) {
			var p = velbus_state;
			var k = d.key.split(".");
			for(var i=0; i<k.length-1; i++ ) {
				if( p[ k[i] ] === undefined ) {
					p[ k[i] ] = {};
				}
				p = p[ k[i] ];
			}
			p[ k[ k.length-1 ] ] = d.value;

			// TODO: Trigger GUI update
		} else {
			console.log("Unknown message received");
			console.log(e);
		}
	};
  </script>
 </body>
</html>
